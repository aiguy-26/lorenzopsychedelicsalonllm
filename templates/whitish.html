<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Let mobile devices scale normally -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mind of McKenna</title>
  <style>
    /* Basic reset */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      overflow-x: hidden;
      font-family: sans-serif;
    }

    /* Outer frame (desktop) */
    .border-frame {
      position: relative;
      display: flex;
      flex-direction: column;
      width: 95%;
      height: 95%;
      max-width: 1776px;
      max-height: 1000px;
      border-radius: 25px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      margin: auto;
      background: url("/static/terencebacgroundirl.png") center center / cover no-repeat;
      overflow: hidden;
      scrollbar-width: none; /* Firefox */
    }
    .border-frame::-webkit-scrollbar {
      width: 0;
      background: transparent;
    }

    .bg-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%; 
      height: 100%;
      background-color: rgba(255,255,255,0);
      transition: background-color 0.5s ease, backdrop-filter 0.5s ease;
      backdrop-filter: blur(0px);
      z-index: 0;
    }
    .bg-overlay.faded {
      background-color: rgba(255,255,255,0.318);
      backdrop-filter: blur(2px);
    }

    /****************************************/
    /* HEADER & NAV ACROSS THE TOP          */
    /****************************************/
    .header-container {
      width: 100%;
      flex-shrink: 0;
      z-index: 2;
      background-color: #464644e9;
      border-bottom: 2px solid #56565480;
    }
    .chat-header {
      color: #a9d6f1;
      text-align: center;
      font-size: 2.5em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 3px 3px 10px rgba(0,0,0,0.6);
      padding: 10px;
    }
    .nav-menu {
      display: flex;
      justify-content: center;
      padding: 8px 0;
    }
    .nav-menu a {
      color: #a9d6f1;
      text-decoration: none;
      font-size: 1.5em;
      padding: 6px 16px;
      transition: background-color 0.3s ease;
    }
    .nav-menu a:hover {
      background-color: #64d6b5;
      color: #1c1b2d;
      border-radius: 10px;
    }

    /****************************************/
    /* MAIN CONTENT (Desktop): SIDEBAR + CHAT */
    /****************************************/
    .chat-container {
      flex: 1 1 auto;
      display: flex;
      flex-direction: row;
      background-color: rgba(123,83,57,0.21);
      border: 5px solid #464644e1;
      z-index: 1;
      overflow: hidden;
    }

    /* Sidebar (Desktop) */
    .sidebar {
      position: relative;
      width: 195px;
      background-color: #464644e9;
      color: white;
      padding: 10px;
      border-right: 2px solid #56565480;
      display: flex;
      flex-direction: column;
      height: 100%;
      transition: width 0.3s ease;
      overflow-x: visible;
      overflow-y: auto;
      z-index: 2;
    }
    .sidebar h2 {
      font-size: 1.5em;
      text-align: center;
      margin-bottom: 1rem;
    }
    .sidebar button {
      margin-bottom: 1rem;
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      background-color: #84a4c3;
      color: black;
      cursor: pointer;
    }
    .sidebar button:hover {
      background-color: #64d6b5;
      color: #1c1b2d;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
      flex-grow: 1;
    }
    .sidebar li {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .sidebar li:hover {
      background-color: rgba(255,255,255,0.2);
    }
    .sidebar.collapsed {
      width: 20px !important;
      padding: 0 !important;
      border: none !important;
    }
    .sidebar.collapsed > :not(.sidebar-tab) {
      display: none;
    }
    .sidebar-tab {
      position: absolute;
      top: 120px;
      left: 100%;
      transform: translateX(-100%);
      width: 20px;
      height: 60px;
      background-color: #464644e9;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 0 5px 5px 0;
      transition: 0.3s ease;
      z-index: 3;
    }
    .sidebar.collapsed .sidebar-tab {
      left: 0;
      transform: translateX(0);
    }

    /* Chat content (Desktop) */
    .chat-content {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      height: 100%;
      border-radius: 0 20px 20px 0;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }
    .chat-box {
      flex-grow: 1;
      padding: 20px 20px 100px 20px; /* extra bottom padding so messages don't hide */
      overflow-y: auto;
      border-radius: 0 0 15px 15px;
    }
    .chat-box::-webkit-scrollbar {
      width: 8px;
    }
    .chat-box::-webkit-scrollbar-thumb {
      background: #b5b5b5;
      border-radius: 10px;
    }
    .chat-box::-webkit-scrollbar-track {
      background: #a8bfd3;
    }

    /* Fixed Input Container (Desktop) */
    .input-container {
      position: absolute;
      bottom: 0;
      left: 200px;
      right: 0;
      height: 50px;
      display: flex;
      flex-direction: row;
      align-items: center;
      padding: 10px 20px;
      gap: 10px;
      z-index: 999;
    }
    .input-container textarea {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #82acd1;
      color: white;
      border-radius: 20px;
      resize: none;
      font-size: 1.2em;
      background-color: #464644e9;
    }
    .input-container textarea::placeholder {
      color: #a8bfd3c8;
      font-style: italic;
      font-size: 1.2em;
    }
    .input-container button {
      padding: 8px 20px;
      font-size: 1.1em;
      border-radius: 8px;
      background-color: #9ab5cc;
      color: black;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .input-container button:hover {
      background-color: #64d6b5;
    }

    /* Chat bubbles */
    .user-message {
      background-color: #464644f8;
      color: white;
      padding: 10px 15px;
      border-radius: 15px;
      margin: 10px 0;
      align-self: flex-end;
      max-width: 80%;
      font-size: 2em;
      margin-right: 20%;
    }
    .assistant-message {
      background-color: #84a4c3f3;
      color: black;
      padding: 10px 15px;
      border-radius: 15px;
      margin: 10px 0;
      align-self: flex-start;
      max-width: 80%;
      font-size: 2em;
      margin-left: 30%;
    }
    .assistant-message a {
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }

    /* Custom Instructions Modal */
    #custom-instructions-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #979580;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 500px;
      border: 3px solid #808582af;
      display: none;
    }

    /**********************/
    /* MOBILE OVERRIDES   */
    /**********************/
    @media (max-width: 768px) {
      .border-frame {
        width: 100%;
        height: 100vh;
        max-width: none;
        max-height: none;
        margin: 0;
        border-radius: 0;
      }
      /* Change layout to column so the chat sits above the input */
      .chat-container {
        flex-direction: column;
        border: none;
      }
      /* Sidebar adjustments on mobile */
      .sidebar {
        width: 60px;
        padding: 5px;
      }
      .sidebar h2 {
        font-size: 1em;
        margin-bottom: 0.5rem;
      }
      .sidebar button {
        padding: 5px 10px;
        font-size: 0.8em;
        margin-bottom: 0.5rem;
      }
      .nav-menu a {
        font-size: 1em;
        padding: 4px 10px;
      }
      .chat-header {
        font-size: 1.8em;
      }
      /* Make chat content take remaining space */
      .chat-content {
        flex: 1 1 auto;
        overflow-y: auto;
      }
      .chat-box {
        padding: 10px;
      }
      /* Input container now becomes relative so it sits below chat */
      .input-container {
        position: relative;
        left: 0;
        right: 0;
        width: 100%;
        height: auto;
        padding: 10px;
        gap: 5px;
        border-radius: 0;
        background-color: #56565480;
      }
      .input-container textarea {
        font-size: 1em;
        padding: 5px;
        min-height: 35px;
      }
      .input-container button {
        font-size: 1em;
        padding: 5px 10px;
      }
      .user-message, .assistant-message {
        font-size: 1em;
        max-width: 70%;
      }
      .sidebar-tab {
        top: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="border-frame" id="frame">
    <div class="bg-overlay"></div>

    <!-- HEADER AT THE TOP -->
    <div class="header-container">
      <div class="chat-header">The Eschaton</div>
      <nav class="nav-menu">
        <a href="/">Home</a>
        <a href="/about">About Terence</a>
        <a href="/mp3">MP3 Talks</a>
        <a href="#" onclick="toggleCustomInstructionsModal()">Settings</a>
      </nav>
    </div>

    <!-- MAIN FLEX AREA: SIDEBAR + CHAT -->
    <div class="chat-container">
      <!-- Sidebar with the tab INSIDE -->
      <div class="sidebar" id="sidebar">
        <h2>Chat History</h2>
        <button onclick="startNewChat()">New Chat</button>
        <ul id="chat-history-list"></ul>
        <div class="sidebar-tab" id="sidebar-tab" onclick="toggleSidebar()">&#9776;</div>
      </div>

      <!-- Chat content (only the chat messages scroll) -->
      <div class="chat-content">
        <div class="chat-box" id="messages"></div>
      </div>
    </div>

    <!-- Fixed Input Container (Desktop only) -->
    <div class="input-container">
      <textarea id="user-input" placeholder="Welcome to the Eschaton...."></textarea>
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Custom Instructions Modal -->
  <div id="custom-instructions-modal">
    <div class="modal-content">
      <h2>Custom Instructions</h2>
      <textarea id="custom-instructions-input" placeholder="Enter custom instructions here..." rows="6"></textarea>
      <div>
        <button onclick="saveCustomInstructions()">Save</button>
        <button onclick="toggleCustomInstructionsModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let chat_id = null;
    let customInstructionsText = "";

    if (!localStorage.getItem("user_id")) {
      localStorage.setItem("user_id", crypto.randomUUID());
    }
    const user_id = localStorage.getItem("user_id");

    function loadChatHistory() {
      fetch(`/list_chats?user_id=${user_id}`)
        .then(response => response.json())
        .then(data => {
          const chatList = document.getElementById("chat-history-list");
          chatList.innerHTML = "";
          data.forEach(chat => {
            const chatItem = document.createElement("li");
            chatItem.textContent = chat.title || "Untitled Chat";
            chatItem.setAttribute("data-chat-id", chat.chat_id);
            chatItem.onclick = function () {
              loadChat(chat.chat_id);
            };
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "❌";
            deleteBtn.style.marginLeft = "10px";
            deleteBtn.style.cursor = "pointer";
            deleteBtn.style.background = "transparent";
            deleteBtn.style.border = "none";
            deleteBtn.style.color = "red";
            deleteBtn.style.fontSize = "1.2em";
            deleteBtn.onclick = function (e) {
              e.stopPropagation();
              if (confirm("Are you sure you want to delete this chat?")) {
                deleteChat(chat.chat_id);
              }
            };
            chatItem.appendChild(deleteBtn);
            chatList.appendChild(chatItem);
          });
        })
        .catch(err => console.error("Failed to load chat sessions:", err));
    }

    function deleteChat(chatId) {
      fetch(`/delete_chat?chat_id=${chatId}&user_id=${user_id}`, {
          method: "DELETE"
      })
      .then(response => response.json())
      .then(result => {
          if (result.status === "success") {
              loadChatHistory();
              if (chat_id === chatId) {
                  chat_id = null;
                  document.getElementById("messages").innerHTML = "";
              }
          } else {
              alert("Error deleting chat: " + result.error);
          }
      })
      .catch(() => alert("Error deleting chat."));
    }

    function loadChat(selectedChatId) {
      chat_id = selectedChatId;
      fetch(`/get_chat?chat_id=${selectedChatId}&user_id=${user_id}`)
        .then(response => response.json())
        .then(data => {
          const messagesContainer = document.getElementById("messages");
          messagesContainer.innerHTML = "";
          if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
              const msgDiv = document.createElement("div");
              msgDiv.className = (msg.role === "user") ? "user-message" : "assistant-message";
              msgDiv.innerHTML = markdownToHTML(msg.content);
              messagesContainer.appendChild(msgDiv);
            });
            // Auto-scroll to the last message (for desktop, chat-box scrollTop is set)
            if (messagesContainer.lastElementChild) {
              messagesContainer.scrollTop = messagesContainer.lastElementChild.offsetTop;
            }
          } else {
            messagesContainer.innerHTML = "<p style='color:white; text-align:center;'>No messages yet. Start the conversation!</p>";
          }
        })
        .catch(err => console.error("Failed to load chat:", err));
    }

    function startNewChat() {
      chat_id = null;
      document.getElementById("messages").innerHTML = "";
    }

    function sendMessage() {
      const message = document.getElementById("user-input").value.trim();
      if (!message) return;
      const messagesContainer = document.getElementById("messages");
      const userMessage = document.createElement("div");
      userMessage.className = "user-message";
      userMessage.textContent = message;
      messagesContainer.appendChild(userMessage);
      document.getElementById("user-input").value = "";
      fetch("/get_response", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_input: message, chat_id: chat_id, user_id: user_id })
      })
      .then(response => response.json())
      .then(data => {
        const aiMessage = document.createElement("div");
        aiMessage.className = "assistant-message";
        aiMessage.innerHTML = markdownToHTML(data.response || "No response.");
        messagesContainer.appendChild(aiMessage);
        if (messagesContainer.lastElementChild) {
          messagesContainer.scrollTop = messagesContainer.lastElementChild.offsetTop;
        }
        if (!chat_id && data.chat_id) {
          chat_id = data.chat_id;
        }
      })
      .catch(() => console.error("Error sending message."));
    }

    function markdownToHTML(text) {
      return text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, p1, p2) =>
        `<a href="${p2}" target="_blank">${p1}</a>`
      );
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('collapsed');
    }

    function toggleCustomInstructionsModal() {
      const modal = document.getElementById('custom-instructions-modal');
      const textarea = document.getElementById('custom-instructions-input');
      textarea.value = localStorage.getItem('customInstructions') || '';
      modal.style.display = (modal.style.display === 'none' || !modal.style.display) ? 'block' : 'none';
    }
    function saveCustomInstructions() {
      const instructions = document.getElementById('custom-instructions-input').value.trim();
      if (instructions) {
        localStorage.setItem('customInstructions', instructions);
        customInstructionsText = instructions;
        alert('Custom instructions saved.');
        toggleCustomInstructionsModal();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadChatHistory();
      document.getElementById('user-input').addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      });
    });
  </script>
</body>
</html>
